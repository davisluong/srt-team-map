<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SR&T Team Location Map - Network Fixed</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .admin-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .admin-toggle:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            height: calc(100vh - 150px);
        }

        .main-content.view-only {
            grid-template-columns: 1fr 350px;
        }

        .map-container {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .toggle-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .toggle-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .toggle-btn.inactive {
            background: #f44336;
        }

        #map {
            height: calc(100% - 60px);
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-y: auto;
        }

        .sidebar.hidden {
            display: none;
        }

        .sidebar h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5rem;
        }

        .view-only-sidebar {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-y: auto;
        }

        .view-only-sidebar h2 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 15px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .coordinates-input {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 5px;
        }

        .coordinates-input input {
            padding: 8px;
            font-size: 12px;
        }

        .manual-coords-toggle {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 5px;
        }

        .manual-coords-toggle:hover {
            background: #138496;
        }

        .autocomplete-container {
            position: relative;
        }

        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .autocomplete-suggestions.active {
            display: block;
        }

        .suggestion-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .suggestion-item:hover,
        .suggestion-item.highlighted {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-main {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .suggestion-details {
            font-size: 12px;
            color: #666;
        }

        .loading-indicator {
            padding: 12px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 10px;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .team-list {
            margin-top: 20px;
        }

        .team-member {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .team-member:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .member-name {
            font-weight: bold;
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .member-role {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .member-locations {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .member-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 5px 12px;
            font-size: 12px;
            width: auto;
            margin: 0;
        }

        .firebase-status {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 12px;
        }

        .firebase-status.error {
            background: #ffebee;
            color: #c62828;
        }

        .network-status {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .network-status.offline {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .network-status.online {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }

        .view-only-info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            border: 1px solid #bbdefb;
        }

        .view-only-info h3 {
            margin-bottom: 8px;
            color: #0d47a1;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 12px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 12px;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 11px;
            font-family: monospace;
            max-height: 150px;
            overflow-y: auto;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
            }
            
            .sidebar, .view-only-sidebar {
                max-height: 400px;
            }

            .admin-toggle {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 20px;
                display: block;
                width: fit-content;
                margin-left: auto;
                margin-right: auto;
            }
        }

        .setup-instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .setup-instructions h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .setup-instructions code {
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }

        .input-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }

        .form-group.has-icon input {
            padding-right: 35px;
        }

        .mode-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            z-index: 1000;
        }

        .mode-indicator.admin {
            background: rgba(220, 53, 69, 0.8);
        }

        .mode-indicator.view {
            background: rgba(40, 167, 69, 0.8);
        }

        .team-member.view-only {
            cursor: default;
        }

        .team-member.view-only:hover {
            transform: none;
        }
		.custom-tooltip {
    background: rgba(0, 0, 0, 0.8) !important;
    color: white !important;
    border: none !important;
    border-radius: 4px !important;
    padding: 4px 8px !important;
    font-size: 12px !important;
    font-weight: bold !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
}

.custom-tooltip::before {
    border-top-color: rgba(0, 0, 0, 0.8) !important;
}

		.toggle-btn.reset {
    background: #6c757d;
}

.toggle-btn.reset:hover {
    background: #5a6268;
    transform: translateY(-2px);
}

		.sidebar-toggle-btn {
    background: #667eea;
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.sidebar-toggle-btn:hover {
    background: #5a6fd8;
    transform: scale(1.1);
}

.view-only-sidebar.collapsed {
    width: 50px !important;
    overflow: hidden;
}

.main-content.sidebar-collapsed {
    grid-template-columns: 1fr 50px;
}

.collapsed-indicator {
    writing-mode: vertical-rl;
    text-orientation: mixed;
    text-align: center;
    padding: 20px 0;
    color: #667eea;
    font-weight: bold;
    font-size: 12px;
    cursor: pointer;
}


    </style>
</head>
<body>
    <div class="container">
        <button class="admin-toggle" onclick="toggleAdminMode()" id="adminToggle">
            🔧 Admin Mode
        </button>

        <div class="header">
            <h1>🌍 SR&T Team Location Map</h1>
            <p><h2>A place called home</h2></p>
        </div>

                <div class="main-content" id="mainContent">
            <div class="map-container">
                <div class="controls">
    <h3>World Map</h3>
    <div style="display: flex; gap: 10px;">
        <button id="toggleLines" class="toggle-btn">🔗 Hide Birth Places</button>
        <button id="resetMap" class="toggle-btn" style="background: #6c757d;">🌍 Reset Map</button>
    </div>
</div>
				<div id="map"></div>
            </div>

            <!-- Admin Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="setup-instructions" id="setupInstructions">
                    <h3>🚀 Network Issue Detected</h3>
                    <p><strong>Your network is blocking geocoding API calls</strong></p>
                    <p>- Using offline mode with manual coordinates</p>
                    <p>- Contact IT to allow access to nominatim.openstreetmap.org</p>
                    <p>- Or use the manual coordinate input below</p>
                </div>

                <div id="firebaseStatus" class="firebase-status error">
                    ⚠️ Firebase not configured. Using local storage.
                </div>

                <div id="networkStatus" class="network-status offline">
                    🔴 Geocoding API Offline - Using Manual Coordinates
                </div>

                <div class="debug-info" id="debugInfo" style="display: none;">
                    <strong>Debug Info:</strong><br>
                    <div id="debugContent"></div>
                </div>

                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>

                <h2>👥 Team Management</h2>
                
                <form id="teamForm">
                    <div class="form-group">
                        <label for="name">Name *</label>
                        <input type="text" id="name" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="role">Role *</label>
                        <input type="text" id="role" required>
                    </div>
                    
                    <div class="form-group has-icon">
                        <label for="currentLocation">Current Location *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="currentLocation" placeholder="e.g., Toronto, Canada" required autocomplete="off">
                            <span class="input-icon">📍</span>
                            <div class="autocomplete-suggestions" id="currentLocationSuggestions"></div>
                        </div>
                        <button type="button" class="manual-coords-toggle" onclick="toggleManualCoords('current')">
                            📊 Manual Coordinates
                        </button>
                        <div class="coordinates-input" id="currentCoords" style="display: none;">
                            <input type="number" step="any" placeholder="Latitude" id="currentLat">
                            <input type="number" step="any" placeholder="Longitude" id="currentLng">
                        </div>
                    </div>
                    
                    <div class="form-group has-icon">
                        <label for="birthPlace">Birth Place *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="birthPlace" placeholder="e.g., London, UK" required autocomplete="off">
                            <span class="input-icon">🏠</span>
                            <div class="autocomplete-suggestions" id="birthPlaceSuggestions"></div>
                        </div>
                        <button type="button" class="manual-coords-toggle" onclick="toggleManualCoords('birth')">
                            📊 Manual Coordinates
                        </button>
                        <div class="coordinates-input" id="birthCoords" style="display: none;">
                            <input type="number" step="any" placeholder="Latitude" id="birthLat">
                            <input type="number" step="any" placeholder="Longitude" id="birthLng">
                        </div>
                    </div>
                    
                     <div class="questions-section">
                        <h3>📋 Additional Information</h3>
                        
                        <div class="question-group">
                            <label for="elementarySchool">Where did you go to Elementary School? *</label>
                            <input type="text" id="elementarySchool" placeholder="City, Country" required autocomplete="off">
                        </div>
                        
                        <div class="question-group">
                            <label for="highSchool">Where did you go to High School? *</label>
                            <input type="text" id="highSchool" placeholder="City, Country" required autocomplete="off">
                        </div>
                        
                        <div class="question-group">
                            <label for="postSecondary">Where did you go to Post Secondary? *</label>
                            <input type="text" id="postSecondary" placeholder="City, Country" required autocomplete="off">
                        </div>
                        
                        <div class="question-group">
                            <label for="placesLived">How many places have you lived? *</label>
                            <input type="text" id="placesLived" placeholder="1,2,3.." required autocomplete="off">
                        </div>
                        
                        <div class="question-group">
                            <label for="canadianProvinces">How many Canadian provinces have you visited? *</label>
                             <input type="text" id="canadianProvinces" placeholder="1,2,3.." required autocomplete="off">
                        </div>
                        
                        <div class="question-group">
                            <label for="countriesVisited">How many countries have you visited? *</label>
                            <input type="text" id="countriesVisited" placeholder="1,2,3.." required autocomplete="off">
                        </div>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">➕ Add Team Member</button>
                    <button type="button" id="cancelEdit" class="btn btn-secondary" style="display: none;">❌ Cancel Edit</button>
                    <button type="button" id="debugToggle" class="btn btn-secondary">🐛 Toggle Debug</button>
                    <button type="button" id="testGeocode" class="btn btn-secondary">🌐 Test Network</button>
                </form>

                <div class="team-list">
                    <h3>Team Members (<span id="memberCount">0</span>)</h3>
                    <div id="teamMembers"></div>
                </div>
            </div>

            <!-- View-Only Sidebar -->
            <div class="view-only-sidebar" id="viewOnlySidebar" style="display: none;">
    <div class="view-only-info">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3>Team Directory</h3>
                <p>Explore our team members and their locations on the map.</p>
            </div>
            <button id="toggleSidebar" class="sidebar-toggle-btn" onclick="toggleSidebar()">
                ◀
            </button>
        </div>
    </div>

                <h2>👥 Our Team (<span id="viewOnlyMemberCount">0</span>)</h2>
                <div id="viewOnlyTeamMembers"></div>
            </div>
        </div>

        <div class="mode-indicator view" id="modeIndicator">
            👁️ View Mode
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Leaflet Maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
	    <script>
        // Initialize all variables at the top
        var db = null;
        var firebaseInitialized = false;
        var teamMembers = [];
        var markers = [];
        var connectionLines = [];
        var showLines = true;
        var editingId = null;
        var isAdminMode = false;
        var searchTimeouts = {};
        var selectedSuggestionIndex = -1;
        var currentSuggestions = [];
        var map = null;
        var debugMode = false;
        var debugLog = [];
        var networkOnline = false;
        var manualCoordsMode = {
            current: false,
            birth: false
        };

        // Common coordinates for major cities (fallback when API is unavailable)
        var cityCoordinates = {
            'toronto, canada': [43.6532, -79.3832],
            'vancouver, canada': [49.2827, -123.1207],
            'montreal, canada': [45.5017, -73.5673],
            'calgary, canada': [51.0447, -114.0719],
            'ottawa, canada': [45.4215, -75.6972],
            'edmonton, canada': [53.5461, -113.4938],
            'winnipeg, canada': [49.8951, -97.1384],
            'quebec city, canada': [46.8139, -71.2080],
            'london, uk': [51.5074, -0.1278],
            'london, england': [51.5074, -0.1278],
            'manchester, uk': [53.4808, -2.2426],
            'birmingham, uk': [52.4862, -1.8904],
            'new york, usa': [40.7128, -74.0060],
            'los angeles, usa': [34.0522, -118.2437],
            'chicago, usa': [41.8781, -87.6298],
            'houston, usa': [29.7604, -95.3698],
            'phoenix, usa': [33.4484, -112.0740],
            'philadelphia, usa': [39.9526, -75.1652],
            'sydney, australia': [-33.8688, 151.2093],
            'melbourne, australia': [-37.8136, 144.9631],
            'brisbane, australia': [-27.4705, 153.0260],
            'tokyo, japan': [35.6762, 139.6503],
            'osaka, japan': [34.6937, 135.5023],
            'beijing, china': [39.9042, 116.4074],
            'shanghai, china': [31.2304, 121.4737],
            'mumbai, india': [19.0760, 72.8777],
            'delhi, india': [28.7041, 77.1025],
            'manila, philippines': [14.5995, 120.9842],
            'manila, capital district': [14.5995, 120.9842],
            'cebu, philippines': [10.3157, 123.8854],
            'davao, philippines': [7.1907, 125.4553],
            'philippines': [12.8797, 121.7740],
            'lahore, pakistan': [31.5204, 74.3587],
            'karachi, pakistan': [24.8607, 67.0011],
            'tehran, iran': [35.6892, 51.3890],
            'durban, south africa': [-29.8587, 31.0218],
            'cape town, south africa': [-33.9249, 18.4241],
            'johannesburg, south africa': [-26.2041, 28.0473],
            'tegucigalpa, honduras': [14.0723, -87.1921],
            'burnaby, canada': [49.2488, -122.9805],
            'brampton, canada': [43.7315, -79.7624],
            'saskatoon, canada': [52.1332, -106.6700],
            'regina, canada': [50.4452, -104.6189],
            'halifax, canada': [44.6488, -63.5752],
            'victoria, canada': [48.4284, -123.3656],
            'nottingham, uk': [52.9548, -1.1581],
            'england, united kingdom': [52.3555, -1.1743],
            'cavite, philippines': [14.4791, 120.8970],
            'marikina, philippines': [14.6507, 121.1029],
            'okotoks, canada': [50.7267, -113.9782],
            'prince george, canada': [53.9171, -122.7497],
            'carrot river, canada': [53.1833, -103.8500],
            'medicine hat, canada': [50.0412, -110.6765],
            'etobicoke, canada': [43.6205, -79.5132],
            'coquitlam, canada': [49.3847, -122.7820],
            'new westminster, canada': [49.2057, -122.9110],
            'city of langley, canada': [49.1042, -122.6604],
            'grande-anse, new brunswick': [47.8064, -64.9141]
        };

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCgEh2UhEZFCFtn_2h_scIA8YHYTPHPy2M",
            authDomain: "srt-team-map.firebaseapp.com",
            databaseURL: "https://srt-team-map-default-rtdb.firebaseio.com",
            projectId: "srt-team-map",
            storageBucket: "srt-team-map.firebasestorage.app",
            messagingSenderId: "1041786833700",
            appId: "1:1041786833700:web:a4927a4e88470cd55d81b1",
            measurementId: "G-J2RNT7MSR1"
        };
		        // Enhanced debug logging
        function addDebugLog(message, data) {  // ← RENAMED FUNCTION
    var timestamp = new Date().toLocaleTimeString();
    var logEntry = timestamp + ': ' + message;
    if (data) {
        logEntry += ' | Data: ' + JSON.stringify(data);
    }
    window.debugLogArray = window.debugLogArray || [];  // ← RENAMED VARIABLE
    window.debugLogArray.push(logEntry);
    
    if (debugMode) {
        console.log(logEntry);
        updateDebugDisplay();
    }
}


        function updateDebugDisplay() {
    var debugContent = document.getElementById('debugContent');
    if (debugContent && window.debugLogArray) {  // ← UPDATED REFERENCE
        debugContent.innerHTML = window.debugLogArray.slice(-10).join('<br>');
    }
}


        function toggleDebugMode() {
            debugMode = !debugMode;
            var debugInfo = document.getElementById('debugInfo');
            if (debugMode) {
                debugInfo.style.display = 'block';
                updateDebugDisplay();
            } else {
                debugInfo.style.display = 'none';
            }
        }

        // Toggle manual coordinates input
        function toggleManualCoords(type) {
            manualCoordsMode[type] = !manualCoordsMode[type];
            var coordsDiv = document.getElementById(type + 'Coords');
            var toggle = event.target;
            
            if (manualCoordsMode[type]) {
                coordsDiv.style.display = 'grid';
                toggle.textContent = '🔤 Text Input';
                toggle.style.background = '#28a745';
            } else {
                coordsDiv.style.display = 'none';
                toggle.textContent = '📊 Manual Coordinates';
                toggle.style.background = '#17a2b8';
            }
        }

        // Test network connectivity
        function testNetworkConnectivity() {
            var testBtn = document.getElementById('testGeocode');
            var networkStatus = document.getElementById('networkStatus');
            
            testBtn.disabled = true;
            testBtn.textContent = '🔄 Testing...';
            networkStatus.textContent = '🔄 Testing network connectivity...';
            networkStatus.className = 'network-status';
            
            // Test with a simple request
            fetch('https://nominatim.openstreetmap.org/search?format=json&q=Toronto&limit=1')
                .then(function(response) {
                    if (response.ok) {
                        networkOnline = true;
                        networkStatus.textContent = '🟢 Geocoding API Online - Network Working!';
                        networkStatus.className = 'network-status online';
                        showMessage('Network test successful! Geocoding API is accessible.', 'success');
                    } else {
                        throw new Error('HTTP ' + response.status);
                    }
                })
                .catch(function(error) {
                    networkOnline = false;
                    networkStatus.textContent = '🔴 Geocoding API Blocked - Using Manual Coordinates';
                    networkStatus.className = 'network-status offline';
                    showMessage('Network blocked. Using offline mode with manual coordinates.', 'error');
                })
                .finally(function() {
                    testBtn.disabled = false;
                    testBtn.textContent = '🌐 Test Network';
                });
        }

        // Fallback geocoding with offline coordinates
        function geocodeLocationWithFallback(location) {
            addDebugLog('Attempting to geocode: ' + location);
            
            // First try offline coordinates
            var cleanLocation = location.toLowerCase().trim();
            if (cityCoordinates[cleanLocation]) {
                addDebugLog('Found offline coordinates for: ' + location, cityCoordinates[cleanLocation]);
                return Promise.resolve(cityCoordinates[cleanLocation]);
            }
            
            // Try partial matches
            for (var city in cityCoordinates) {
                if (cleanLocation.includes(city.split(',')[0]) || city.includes(cleanLocation.split(',')[0])) {
                    addDebugLog('Found partial match for: ' + location + ' -> ' + city, cityCoordinates[city]);
                    return Promise.resolve(cityCoordinates[city]);
                }
            }
            
            // If network is available, try API
            if (networkOnline) {
                return geocodeLocation(location);
            }
            
            // No coordinates found
            addDebugLog('No coordinates found for: ' + location);
            showMessage('No coordinates found for: ' + location + '. Please use manual coordinates.', 'error');
            return Promise.resolve(null);
        }

        // Enhanced geocoding with retry logic
        function geocodeLocation(location, retryCount = 0) {
            addDebugLog('API geocoding location: ' + location, { retryCount: retryCount });
            
            return fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(location))
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('HTTP ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    if (data && data.length > 0) {
                        var coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                        addDebugLog('API geocoded successfully: ' + location, { coords: coords });
                        return coords;
                    }
                    addDebugLog('No API results for: ' + location);
                    return null;
                })
                .catch(function(error) {
                    console.error('Geocoding error for "' + location + '":', error);
                    addDebugLog('API geocoding error: ' + location, { error: error.message });
                    
                    // Mark network as offline on connection errors
                    if (error.message.includes('Failed to fetch') || error.message.includes('ERR_TUNNEL_CONNECTION_FAILED')) {
                        networkOnline = false;
                        var networkStatus = document.getElementById('networkStatus');
                        if (networkStatus) {
                            networkStatus.textContent = '🔴 Geocoding API Blocked - Using Manual Coordinates';
                            networkStatus.className = 'network-status offline';
                        }
                    }
                    
                    // Retry logic for rate limiting
                    if (retryCount < 2 && (error.message.includes('429') || error.message.includes('HTTP 429'))) {
                        var delay = (retryCount + 1) * 2000; // 2s, 4s delays
                        addDebugLog('Retrying geocoding after ' + delay + 'ms: ' + location);
                        return new Promise(function(resolve) {
                            setTimeout(function() {
                                resolve(geocodeLocation(location, retryCount + 1));
                            }, delay);
                        });
                    }
                    
                    return null;
                });
        }

        // Function to handle international date line crossing
        function createOptimalPolyline(coord1, coord2) {
            var lat1 = coord1[0], lon1 = coord1[1];
            var lat2 = coord2[0], lon2 = coord2[1];
            
            // Calculate the difference in longitude
            var lonDiff = Math.abs(lon2 - lon1);
            
            addDebugLog('Creating line between coordinates', { 
                from: coord1, 
                to: coord2, 
                lonDiff: lonDiff 
            });
            
            // If the longitude difference is greater than 180°, we need to handle date line crossing
            if (lon1 > 0 && lon2 < 0 && lonDiff > 180) {
                // Going from positive to negative longitude (crossing date line eastward)
                var midLat = (lat1 + lat2) / 2;
                return [
                    L.polyline([[lat1, lon1], [midLat, 180]], {
                        color: '#ff6b6b',
                        weight: 2,
                        opacity: 0.7,
                        dashArray: '8, 8'
                    }),
                    L.polyline([[midLat, -180], [lat2, lon2]], {
                        color: '#ff6b6b',
                        weight: 2,
                        opacity: 0.7,
                        dashArray: '8, 8'
                    })
                ];
            } else if (lon1 < 0 && lon2 > 0 && lonDiff > 180) {
                // Going from negative to positive longitude (crossing date line westward)
                var midLat = (lat1 + lat2) / 2;
                return [
                    L.polyline([[lat1, lon1], [midLat, -180]], {
                        color: '#ff6b6b',
                        weight: 2,
                        opacity: 0.7,
                        dashArray: '8, 8'
                    }),
                    L.polyline([[midLat, 180], [lat2, lon2]], {
                        color: '#ff6b6b',
                        weight: 2,
                        opacity: 0.7,
                        dashArray: '8, 8'
                    })
                ];
            } else {
                // Normal case - no date line crossing
                return [L.polyline([coord1, coord2], {
                    color: '#ff6b6b',
                    weight: 2,
                        opacity: 0.7,
                        dashArray: '8, 8'
                })];
            }
        }

        // Utility functions
        function showMessage(message, type) {
            type = type || 'info';
            console.log('[' + type.toUpperCase() + '] ' + message);
            addDebugLog(message);
            
            if (type === 'success') {
                var successEl = document.getElementById('successMessage');
                if (successEl) {
                    successEl.textContent = message;
                    successEl.style.display = 'block';
                    setTimeout(function() { successEl.style.display = 'none'; }, 3000);
                }
            } else if (type === 'error') {
                var errorEl = document.getElementById('errorMessage');
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                    setTimeout(function() { errorEl.style.display = 'none'; }, 5000);
                }
            }
        }

        // Initialize Firebase
        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseInitialized = true;
                showMessage('✅ Firebase connected successfully!', 'success');
                var statusEl = document.getElementById('firebaseStatus');
                if (statusEl) {
                    statusEl.innerHTML = '✅ Firebase connected successfully!';
                    statusEl.className = 'firebase-status';
                }
            } catch (error) {
                console.log('Firebase not configured - using local storage');
                showMessage('Using local storage (Firebase not configured)', 'info');
            }
        }

        // Initialize Map with improved options
        function initializeMap() {
    var mapContainer = document.getElementById('map');
    if (!mapContainer) {
        console.error('Map container with id "map" not found!');
        showMessage('Map container not found. Please check HTML structure.', 'error');
        return;
    }
    
    try {
        map = L.map('map', {
            center: [20, 0],
            zoom: 2,
            minZoom: 2,
            maxZoom: 18,
            worldCopyJump: true,
            maxBounds: [[-90, -180], [90, 180]],
            maxBoundsViscosity: 1.0
        });
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            noWrap: true
        }).addTo(map);
        
        showMessage('Map initialized successfully', 'success');
    } catch (error) {
        console.error('Error initializing map:', error);
        showMessage('Error initializing map: ' + error.message, 'error');
    }
}


        // Check if admin mode is enabled
        function checkAdminMode() {
            var urlParams = new URLSearchParams(window.location.search);
            isAdminMode = urlParams.get('admin') === 'true';
            updateUIMode();
        }

        // Toggle admin mode
        function toggleAdminMode() {
            isAdminMode = !isAdminMode;
            var url = new URL(window.location);
            if (isAdminMode) {
                url.searchParams.set('admin', 'true');
            } else {
                url.searchParams.delete('admin');
            }
            window.history.replaceState({}, '', url);
            updateUIMode();
        }

        // Update UI based on mode
        function updateUIMode() {
            var mainContent = document.getElementById('mainContent');
            var sidebar = document.getElementById('sidebar');
            var viewOnlySidebar = document.getElementById('viewOnlySidebar');
            var adminToggle = document.getElementById('adminToggle');
            var modeIndicator = document.getElementById('modeIndicator');

            if (isAdminMode) {
                mainContent.classList.remove('view-only');
                sidebar.classList.remove('hidden');
                sidebar.style.display = 'block';
                viewOnlySidebar.style.display = 'none';
                adminToggle.innerHTML = '👁️ View Mode';
                modeIndicator.innerHTML = '🔧 Admin Mode';
                modeIndicator.className = 'mode-indicator admin';
                showMessage('Admin mode enabled', 'success');
            } else {
                mainContent.classList.add('view-only');
                sidebar.classList.add('hidden');
                sidebar.style.display = 'none';
                viewOnlySidebar.style.display = 'block';
                adminToggle.innerHTML = '🔧 Admin Mode';
                modeIndicator.innerHTML = '👁️ View Mode';
                modeIndicator.className = 'mode-indicator view';
                showMessage('View-only mode enabled', 'info');
                displayViewOnlyTeamMembers();
            }

            if (map) {
                setTimeout(function() {
                    map.invalidateSize();
                }, 100);
            }
        }
		        // Search locations using Nominatim API (only if network is online)
        function searchLocations(query, suggestionsContainer, inputElement) {
            if (!networkOnline) {
                showOfflineSuggestions(query, suggestionsContainer, inputElement);
                return;
            }
            
            showLoadingIndicator(suggestionsContainer);
            showMessage('Searching for: ' + query, 'info');
            
            fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(query) + '&limit=8&addressdetails=1')
                .then(function(response) {
                    return response.json();
                })
                .then(function(data) {
                    if (data && data.length > 0) {
                        currentSuggestions = data;
                        displaySuggestions(data, suggestionsContainer, inputElement);
                        showMessage('Found ' + data.length + ' suggestions', 'info');
                    } else {
                        showNoResults(suggestionsContainer);
                        showMessage('No locations found', 'info');
                    }
                })
                .catch(function(error) {
                    console.error('Location search error:', error);
                    networkOnline = false;
                    showOfflineSuggestions(query, suggestionsContainer, inputElement);
                });
        }

        // Show offline suggestions based on cached coordinates
        function showOfflineSuggestions(query, suggestionsContainer, inputElement) {
            var cleanQuery = query.toLowerCase().trim();
            var matches = [];
            
            for (var city in cityCoordinates) {
                if (city.includes(cleanQuery) || cleanQuery.includes(city.split(',')[0])) {
                    matches.push({
                        display_name: city.charAt(0).toUpperCase() + city.slice(1),
                        offline: true
                    });
                }
            }
            
            if (matches.length > 0) {
                currentSuggestions = matches;
                displaySuggestions(matches, suggestionsContainer, inputElement);
            } else {
                suggestionsContainer.innerHTML = '<div class="loading-indicator">No offline matches. Use manual coordinates.</div>';
                suggestionsContainer.classList.add('active');
            }
        }

        // Display search suggestions
        function displaySuggestions(suggestions, container, inputElement) {
            selectedSuggestionIndex = -1;
            
            var html = suggestions.map(function(suggestion, index) {
                var displayName = suggestion.display_name;
                var isOffline = suggestion.offline;
                
                if (!isOffline) {
                    var parts = displayName.split(',');
                    var mainLocation = parts.slice(0, 2).join(',').trim();
                    var details = parts.slice(2).join(',').trim();
                } else {
                    var mainLocation = displayName;
                    var details = '(Offline coordinates)';
                }

                return '<div class="suggestion-item" data-index="' + index + '" onclick="selectSuggestion(' + index + ', \'' + inputElement.id + '\')">' +
                    '<div class="suggestion-main">' + mainLocation + '</div>' +
                    (details ? '<div class="suggestion-details">' + details + '</div>' : '') +
                    '</div>';
            }).join('');

            container.innerHTML = html;
            container.classList.add('active');
        }

        // Select a suggestion
        function selectSuggestion(index, inputId) {
            if (currentSuggestions[index]) {
                var suggestion = currentSuggestions[index];
                var input = document.getElementById(inputId);
                var container = document.getElementById(inputId + 'Suggestions');
                
                var displayName = suggestion.display_name;
                var cleanName;
                
                if (suggestion.offline) {
                    cleanName = displayName;
                } else {
                    var parts = displayName.split(',');
                    cleanName = parts.slice(0, 2).join(',').trim();
                }
                
                input.value = cleanName;
                hideSuggestions(container);
                input.focus();
                showMessage('Selected location: ' + cleanName, 'info');
            }
        }

        // Show loading indicator
        function showLoadingIndicator(container) {
            container.innerHTML = '<div class="loading-indicator">🔍 Searching locations...</div>';
            container.classList.add('active');
        }

        // Show no results message
        function showNoResults(container) {
            container.innerHTML = '<div class="loading-indicator">No locations found</div>';
            container.classList.add('active');
        }

        // Show error message
        function showError(container) {
            container.innerHTML = '<div class="loading-indicator">Search temporarily unavailable</div>';
            container.classList.add('active');
        }

        // Hide suggestions
        function hideSuggestions(container) {
            container.classList.remove('active');
            selectedSuggestionIndex = -1;
        }

        // Setup autocomplete
        function setupAutocomplete(inputId) {
            var input = document.getElementById(inputId);
            var suggestionsContainer = document.getElementById(inputId + 'Suggestions');

            if (!input || !suggestionsContainer) {
                showMessage('Autocomplete setup failed for ' + inputId, 'error');
                return;
            }

            input.addEventListener('input', function() {
                var query = this.value.trim();
                if (query.length < 2) {
                    hideSuggestions(suggestionsContainer);
                    return;
                }

                if (searchTimeouts[inputId]) {
                    clearTimeout(searchTimeouts[inputId]);
                }

                searchTimeouts[inputId] = setTimeout(function() {
                    searchLocations(query, suggestionsContainer, input);
                }, 500);
            });

            input.addEventListener('blur', function() {
                setTimeout(function() {
                    hideSuggestions(suggestionsContainer);
                }, 200);
            });

            input.addEventListener('focus', function() {
                if (this.value.trim().length >= 2) {
                    var query = this.value.trim();
                    searchLocations(query, suggestionsContainer, input);
                }
            });

            showMessage('Autocomplete setup complete for ' + inputId, 'info');
        }

        // Form submission handler
        function handleFormSubmit(e) {
            e.preventDefault();
            showMessage('Form submitted', 'info');
            
            var submitBtn = document.getElementById('submitBtn');
            var originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '⏳ Saving...';
                
                var formData = {
                    name: document.getElementById('name').value.trim(),
                    role: document.getElementById('role').value.trim(),
                    currentLocation: document.getElementById('currentLocation').value.trim(),
                    birthPlace: document.getElementById('birthPlace').value.trim(),
                    elementarySchool: document.getElementById('elementarySchool').value.trim(),
                    highSchool: document.getElementById('highSchool').value.trim(),
                    postSecondary: document.getElementById('postSecondary').value.trim(),
                    placesLived: document.getElementById('placesLived').value,
                    canadianProvinces: document.getElementById('canadianProvinces').value,
                    countriesVisited: document.getElementById('countriesVisited').value,
                    timestamp: new Date().toISOString()
                };

                // Add manual coordinates if provided
                if (manualCoordsMode.current) {
                    var currentLat = document.getElementById('currentLat').value;
                    var currentLng = document.getElementById('currentLng').value;
                    if (currentLat && currentLng) {
                        formData.currentCoords = [parseFloat(currentLat), parseFloat(currentLng)];
                    }
                }

                if (manualCoordsMode.birth) {
                    var birthLat = document.getElementById('birthLat').value;
                    var birthLng = document.getElementById('birthLng').value;
                    if (birthLat && birthLng) {
                        formData.birthCoords = [parseFloat(birthLat), parseFloat(birthLng)];
                    }
                }

                showMessage('Form data: ' + JSON.stringify(formData), 'info');

                if (!formData.name || !formData.role || !formData.currentLocation || !formData.birthPlace) {
                    throw new Error('Please fill in all required fields');
                }

                if (editingId) {
                    showMessage('Updating team member with ID: ' + editingId, 'info');
                    updateTeamMember(editingId, formData).then(function() {
                        showMessage('Team member updated successfully!', 'success');
                        document.getElementById('teamForm').reset();
                        cancelEdit();
                        loadTeamMembers();
                    });
                } else {
                    showMessage('Adding new team member', 'info');
                    addTeamMember(formData).then(function() {
                        showMessage('Team member added successfully!', 'success');
                        document.getElementById('teamForm').reset();
                        cancelEdit();
                        loadTeamMembers();
                    });
                }
                
            } catch (error) {
                console.error('Error saving team member:', error);
                showMessage('Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // Add team member
        function addTeamMember(memberData) {
            showMessage('Adding team member to database', 'info');
            
            return new Promise(function(resolve, reject) {
                if (firebaseInitialized) {
                    showMessage('Using Firebase', 'info');
                    db.collection('teamMembers').add(memberData).then(function(docRef) {
                        showMessage('Firebase document created with ID: ' + docRef.id, 'info');
                        resolve();
                    }).catch(reject);
                } else {
                    showMessage('Using localStorage', 'info');
                    var members = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                    memberData.id = Date.now().toString();
                    members.push(memberData);
                    localStorage.setItem('teamMembers', JSON.stringify(members));
                    showMessage('LocalStorage updated, new member count: ' + members.length, 'info');
                    resolve();
                }
            });
        }

        // Update team member
        function updateTeamMember(id, memberData) {
            showMessage('Updating team member: ' + id, 'info');
            
            return new Promise(function(resolve, reject) {
                if (firebaseInitialized) {
                    db.collection('teamMembers').doc(id).update(memberData).then(function() {
                        showMessage('Firebase document updated', 'info');
                        resolve();
                    }).catch(reject);
                } else {
                    var members = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                    var index = members.findIndex(function(m) { return m.id === id; });
                    if (index !== -1) {
                        members[index] = Object.assign(members[index], memberData);
                        localStorage.setItem('teamMembers', JSON.stringify(members));
                        showMessage('LocalStorage member updated', 'info');
                        resolve();
                    } else {
                        reject(new Error('Team member not found'));
                    }
                }
            });
        }

        // Delete team member
        function deleteTeamMember(id) {
            if (confirm('Are you sure you want to delete this team member?')) {
                try {
                    if (firebaseInitialized) {
                        db.collection('teamMembers').doc(id).delete();
                    } else {
                        var members = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                        var filtered = members.filter(function(m) { return m.id !== id; });
                        localStorage.setItem('teamMembers', JSON.stringify(filtered));
                    }
                    showMessage('Team member deleted successfully', 'success');
                    loadTeamMembers();
                } catch (error) {
                    showMessage('Error deleting team member: ' + error.message, 'error');
                }
            }
        }

        // Load team members
        function loadTeamMembers() {
            try {
                showMessage('Loading team members', 'info');
                
                if (firebaseInitialized) {
                    showMessage('Loading from Firebase', 'info');
                    db.collection('teamMembers').get().then(function(snapshot) {
                        teamMembers = snapshot.docs.map(function(doc) {
                            return Object.assign({ id: doc.id }, doc.data());
                        });
                        showMessage('Loaded ' + teamMembers.length + ' members from Firebase', 'info');
                        displayTeamMembers();
                        displayViewOnlyTeamMembers();
                        updateMap();
                        updateUIMode();
                    });
                } else {
                    showMessage('Loading from localStorage', 'info');
                    teamMembers = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                    showMessage('Loaded ' + teamMembers.length + ' members from localStorage', 'info');
                    displayTeamMembers();
                    displayViewOnlyTeamMembers();
                    updateMap();
                    updateUIMode();
                }
            } catch (error) {
                console.error('Error loading team members:', error);
                showMessage('Error loading team members: ' + error.message, 'error');
            }
        }

			var sidebarCollapsed = false;

function toggleSidebar() {
    var sidebar = document.getElementById('viewOnlySidebar');
    var mainContent = document.getElementById('mainContent');
    var toggleBtn = document.getElementById('toggleSidebar');
    
    sidebarCollapsed = !sidebarCollapsed;
    
    if (sidebarCollapsed) {
        // Collapse sidebar
        sidebar.classList.add('collapsed');
        mainContent.classList.add('sidebar-collapsed');
        toggleBtn.innerHTML = '▶';
        toggleBtn.title = 'Show Team Directory';
        
        // Hide content and show vertical text
        var membersList = document.getElementById('viewOnlyTeamMembers');
        var info = sidebar.querySelector('.view-only-info');
        
        membersList.style.display = 'none';
        info.innerHTML = '<div class="collapsed-indicator" onclick="toggleSidebar()">TEAM</div>';
        
    } else {
        // Expand sidebar
        sidebar.classList.remove('collapsed');
        mainContent.classList.remove('sidebar-collapsed');
        toggleBtn.innerHTML = '◀';
        toggleBtn.title = 'Hide Team Directory';
        
        // Restore content
        var membersList = document.getElementById('viewOnlyTeamMembers');
        membersList.style.display = 'block';
        
        // Restore original header
        var info = sidebar.querySelector('.view-only-info');
        info.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h3>Team Directory</h3>
                    <p>Explore our team members and their locations on the map.</p>
                </div>
                <button id="toggleSidebar" class="sidebar-toggle-btn" onclick="toggleSidebar()">
                    ◀
                </button>
            </div>
        `;
    }
    
    // Refresh map size after sidebar toggle
    if (map) {
        setTimeout(function() {
            map.invalidateSize();
        }, 300);
    }
}

			
		      // Generate questions HTML for display
        function generateQuestionsHTML(member) {
            var questions = [];
            
            if (member.elementarySchool) {
                questions.push('<div class="question-item"><span class="question-label">Elementary:</span> ' + member.elementarySchool + '</div>');
            }
            if (member.highSchool) {
                questions.push('<div class="question-item"><span class="question-label">High School:</span> ' + member.highSchool + '</div>');
            }
            if (member.postSecondary) {
                questions.push('<div class="question-item"><span class="question-label">Post Secondary:</span> ' + member.postSecondary + '</div>');
            }
            if (member.placesLived) {
                questions.push('<div class="question-item"><span class="question-label">Places Lived:</span> ' + member.placesLived + '</div>');
            }
            if (member.canadianProvinces) {
                questions.push('<div class="question-item"><span class="question-label">Provinces Visited:</span> ' + member.canadianProvinces + '</div>');
            }
            if (member.countriesVisited) {
                questions.push('<div class="question-item"><span class="question-label">Countries Visited:</span> ' + member.countriesVisited + '</div>');
            }
            
            return questions.length > 0 ? '<div class="member-questions">' + questions.join('') + '</div>' : '';
        }
			
			// Generate questions HTML for map popups (more compact format)
function generatePopupQuestionsHTML(member) {
    var questions = [];
    
    if (member.elementarySchool) {
        questions.push('<div style="margin: 2px 0; font-size: 11px;"><span style="color: #666; font-weight: 600;">Elementary:</span> ' + member.elementarySchool + '</div>');
    }
    if (member.highSchool) {
        questions.push('<div style="margin: 2px 0; font-size: 11px;"><span style="color: #666; font-weight: 600;">High School:</span> ' + member.highSchool + '</div>');
    }
    if (member.postSecondary) {
        questions.push('<div style="margin: 2px 0; font-size: 11px;"><span style="color: #666; font-weight: 600;">Post Secondary:</span> ' + member.postSecondary + '</div>');
    }
    if (member.placesLived) {
        questions.push('<div style="margin: 2px 0; font-size: 11px;"><span style="color: #666; font-weight: 600;">Places Lived:</span> ' + member.placesLived + '</div>');
    }
    if (member.canadianProvinces) {
        questions.push('<div style="margin: 2px 0; font-size: 11px;"><span style="color: #666; font-weight: 600;">Provinces Visited:</span> ' + member.canadianProvinces + '</div>');
    }
    if (member.countriesVisited) {
        questions.push('<div style="margin: 2px 0; font-size: 11px;"><span style="color: #666; font-weight: 600;">Countries Visited:</span> ' + member.countriesVisited + '</div>');
    }
    
    if (questions.length > 0) {
        return '<div style="margin: 8px 0; padding: 6px; background: #f8f9fa; border-radius: 4px; border-left: 3px solid #007bff;">' +
               '<div style="font-size: 11px; font-weight: bold; color: #333; margin-bottom: 4px;">📋 Additional Info:</div>' +
               questions.join('') +
               '</div>';
    }
    
    return '';
}


        // Display team members in admin sidebar
        function displayTeamMembers() {
            var container = document.getElementById('teamMembers');
            var count = document.getElementById('memberCount');
            
            if (count) count.textContent = teamMembers.length;
            
            if (teamMembers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No team members added yet.</p>';
                return;
            }

            container.innerHTML = teamMembers.map(function(member) {
                return '<div class="team-member">' +
                    '<div class="member-name">' + member.name + '</div>' +
                    '<div class="member-role">' + member.role + '</div>' +
                    '<div class="member-locations">' +
                        '📍 Current: ' + member.currentLocation + '<br>' +
                        '🏠 Born: ' + member.birthPlace +
                    generateQuestionsHTML(member) +
                    '</div>' +
                    '<div class="member-actions">' +
                        '<button class="btn btn-secondary btn-small" onclick="editTeamMember(\'' + member.id + '\')">✏️ Edit</button>' +
                        '<button class="btn btn-danger btn-small" onclick="deleteTeamMember(\'' + member.id + '\')">🗑️ Delete</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // Display team members in view-only sidebar
        function displayViewOnlyTeamMembers() {
            var container = document.getElementById('viewOnlyTeamMembers');
            var count = document.getElementById('viewOnlyMemberCount');
            
            if (count) count.textContent = teamMembers.length;
            
            if (teamMembers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No team members to display.</p>';
                return;
            }

            container.innerHTML = teamMembers.map(function(member) {
                return '<div class="team-member view-only">' +
                    '<div class="member-name">' + member.name + '</div>' +
                    '<div class="member-role">' + member.role + '</div>' +
                    '<div class="member-locations">' +
                        '📍 Current: ' + member.currentLocation + '<br>' +
                        '🏠 Born: ' + member.birthPlace +
                    generateQuestionsHTML(member) +
                    '</div>' +
                '</div>';
            }).join('');
        }

        // Edit team member
        function editTeamMember(id) {
            var member = teamMembers.find(function(m) { return m.id === id; });
            if (!member) return;

            document.getElementById('name').value = member.name;
            document.getElementById('role').value = member.role;
            document.getElementById('currentLocation').value = member.currentLocation;
            document.getElementById('birthPlace').value = member.birthPlace;
            document.getElementById('elementarySchool').value = member.elementarySchool || '';
            document.getElementById('highSchool').value = member.highSchool || '';
            document.getElementById('postSecondary').value = member.postSecondary || '';
            document.getElementById('placesLived').value = member.placesLived || '';
            document.getElementById('canadianProvinces').value = member.canadianProvinces || '';
            document.getElementById('countriesVisited').value = member.countriesVisited || '';

            // Load manual coordinates if they exist
            if (member.currentCoords) {
                document.getElementById('currentLat').value = member.currentCoords[0];
                document.getElementById('currentLng').value = member.currentCoords[1];
                toggleManualCoords('current');
            }
            if (member.birthCoords) {
                document.getElementById('birthLat').value = member.birthCoords[0];
                document.getElementById('birthLng').value = member.birthCoords[1];
                toggleManualCoords('birth');
            }

            editingId = id;
            document.getElementById('cancelEdit').style.display = 'block';
            document.querySelector('.btn[type="submit"]').textContent = '💾 Update Team Member';
            showMessage('Editing team member: ' + member.name, 'info');
        }

        // Cancel edit
        function cancelEdit() {
            editingId = null;
            document.getElementById('cancelEdit').style.display = 'none';
            document.querySelector('.btn[type="submit"]').textContent = '➕ Add Team Member';
            document.getElementById('teamForm').reset();
            
            // Reset manual coordinate toggles
            if (manualCoordsMode.current) {
                toggleManualCoords('current');
            }
            if (manualCoordsMode.birth) {
                toggleManualCoords('birth');
            }
            
            showMessage('Edit cancelled', 'info');
        }

		// Function to offset markers that are too close together
function offsetMarker(coords, existingCoords, radius = 0.01) {
    var lat = coords[0];
    var lng = coords[1];
    var attempts = 0;
    var maxAttempts = 20;
    
    while (attempts < maxAttempts) {
        var tooClose = false;
        
        for (var i = 0; i < existingCoords.length; i++) {
            var existingLat = existingCoords[i][0];
            var existingLng = existingCoords[i][1];
            var distance = Math.sqrt(Math.pow(lat - existingLat, 2) + Math.pow(lng - existingLng, 2));
            
            if (distance < radius) {
                tooClose = true;
                break;
            }
        }
        
        if (!tooClose) {
            return [lat, lng];
        }
        
        // Create spiral offset
        var angle = (attempts * 137.5) * (Math.PI / 180); // Golden angle
        var distance = radius * Math.sqrt(attempts + 1);
        lat = coords[0] + (distance * Math.cos(angle));
        lng = coords[1] + (distance * Math.sin(angle));
        attempts++;
    }
    
    return [lat, lng];
}

			
        // Update map with team members
        function updateMap() {
            if (!map) return;
            
            showMessage('Updating map', 'info');
            
            markers.forEach(function(marker) { map.removeLayer(marker); });
connectionLines.forEach(function(line) { map.removeLayer(line); });
markers = [];
connectionLines = [];
var usedCurrentCoords = []; // Track used coordinates
var usedBirthCoords = [];   // Track used coordinates


            var promises = teamMembers.map(function(member) {
                // Use manual coordinates if available, otherwise geocode
                var currentPromise = member.currentCoords ? 
                    Promise.resolve(member.currentCoords) : 
                    geocodeLocationWithFallback(member.currentLocation);
                    
                var birthPromise = member.birthCoords ? 
                    Promise.resolve(member.birthCoords) : 
                    geocodeLocationWithFallback(member.birthPlace);

                return Promise.all([currentPromise, birthPromise]).then(function(coords) {
                    var currentCoords = coords[0];
                    var birthCoords = coords[1];

                    // Always show current location markers
                    if (currentCoords) {
    // Offset if too close to existing markers
    var adjustedCurrentCoords = offsetMarker(currentCoords, usedCurrentCoords);
    usedCurrentCoords.push(adjustedCurrentCoords);
    
    var currentMarker = L.marker(adjustedCurrentCoords, {

                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background: #007bff; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">📍</div>',
                                iconSize: [30, 30],
                                iconAnchor: [15, 15]
                            })
                        }).addTo(map);

                        currentMarker.bindPopup(
    '<div style="font-family: \'Segoe UI\', sans-serif; max-width: 300px;">' +
        '<h4 style="margin: 0 0 8px 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 4px;">' + member.name + '</h4>' +
        '<p style="margin: 0 0 8px 0; color: #007bff; font-weight: bold; font-size: 14px;">' + member.role + '</p>' +
        '<div style="margin-bottom: 10px;">' +
            '<p style="margin: 0 0 4px 0; font-size: 12px;"><strong>📍 Current:</strong> ' + member.currentLocation + '</p>' +
            '<p style="margin: 0 0 4px 0; font-size: 12px;"><strong>🏠 Born:</strong> ' + member.birthPlace + '</p>' +
        '</div>' +
        generatePopupQuestionsHTML(member) +
        (member.notes ? '<p style="margin: 8px 0 0 0; font-size: 11px; color: #666; font-style: italic; border-top: 1px solid #eee; padding-top: 6px;">' + member.notes + '</p>' : '') +
    '</div>'
);
						// NEW: Add hover tooltip
currentMarker.bindTooltip(member.name, {
    permanent: false,
    direction: 'top',
    offset: [0, -10],
    className: 'custom-tooltip'
});
                        markers.push(currentMarker);
                    }

                    // Only show birth place markers and connection lines when showLines is true
                    if (showLines && birthCoords) {
    // Offset if too close to existing markers
    var adjustedBirthCoords = offsetMarker(birthCoords, usedBirthCoords);
    usedBirthCoords.push(adjustedBirthCoords);
    
    var birthMarker = L.marker(adjustedBirthCoords, {

                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: '<div style="background: #28a745; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">🏠</div>',
                                iconSize: [25, 25],
                                iconAnchor: [12.5, 12.5]
                            })
                        }).addTo(map);

                        birthMarker.bindPopup(
    '<div style="font-family: \'Segoe UI\', sans-serif; max-width: 300px;">' +
        '<h4 style="margin: 0 0 8px 0; color: #333; border-bottom: 2px solid #28a745; padding-bottom: 4px;">' + member.name + '</h4>' +
        '<p style="margin: 0 0 8px 0; color: #28a745; font-weight: bold; font-size: 14px;">🏠 Birth Place</p>' +
        '<p style="margin: 0 0 8px 0; font-size: 12px;">' + member.birthPlace + '</p>' +
        '<p style="margin: 0 0 8px 0; color: #007bff; font-weight: 600; font-size: 12px;">' + member.role + '</p>' +
        generatePopupQuestionsHTML(member) +
    '</div>'
);
						// NEW: Add hover tooltip
birthMarker.bindTooltip(member.name + ' (Birth Place)', {
    permanent: false,
    direction: 'top',
    offset: [0, -10],
    className: 'custom-tooltip'
});
                        markers.push(birthMarker);
                    }

                    // Only show connection lines when showLines is true
                    if (showLines && adjustedCurrentCoords && adjustedBirthCoords) {
   					 var polylines = createOptimalPolyline(adjustedCurrentCoords, adjustedBirthCoords);
                        polylines.forEach(function(polyline) {
                            polyline.addTo(map);
                            connectionLines.push(polyline);
                        });
                    }
                });
            });

            Promise.all(promises).then(function() {
                if (markers.length > 0) {
                    var group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                showMessage('Map updated with ' + markers.length + ' markers', 'info');
            });
        }

        // Toggle connection lines and birth places
        function toggleConnectionLines() {
            showLines = !showLines;
            var button = document.getElementById('toggleLines');
            
            if (showLines) {
                button.textContent = '🔗 Hide Birth Places & Lines';
                button.className = 'toggle-btn';
            } else {
                button.textContent = '🔗 Show Birth Places & Lines';
                button.className = 'toggle-btn inactive';
            }

            updateMap();
        }

			// Reset map to world view
function resetMapView() {
    if (!map) return;
    
    // Smooth zoom out with animation
    map.flyTo([20, 0], 2, {
        duration: 1.5,
        easeLinearity: 0.25
    });
    
    showMessage('Map reset to world view', 'info');
}

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
    showMessage('DOM loaded, initializing application', 'info');
    
    // Initialize in sequence with error handling
    try {
        initializeFirebase();
        
        // Wait for DOM to be completely ready
        setTimeout(function() {
            initializeMap();
            checkAdminMode();
            loadTeamMembers();
            setupEventListeners();
        }, 200);
        
    } catch (error) {
        console.error('Initialization error:', error);
        showMessage('Application initialization failed: ' + error.message, 'error');
    }
});

function setupEventListeners() {
    var teamForm = document.getElementById('teamForm');
    if (teamForm) {
        teamForm.addEventListener('submit', handleFormSubmit);
    }
    
    var toggleLinesBtn = document.getElementById('toggleLines');
    if (toggleLinesBtn) {
        toggleLinesBtn.addEventListener('click', toggleConnectionLines);
    }
    
    var resetMapBtn = document.getElementById('resetMap');
    if (resetMapBtn) {
        resetMapBtn.addEventListener('click', resetMapView);
    }
            
            var cancelEditBtn = document.getElementById('cancelEdit');
            if (cancelEditBtn) {
                cancelEditBtn.addEventListener('click', cancelEdit);
            }
            
            var debugToggleBtn = document.getElementById('debugToggle');
            if (debugToggleBtn) {
                debugToggleBtn.addEventListener('click', toggleDebugMode);
            }
            
            var testGeocodeBtn = document.getElementById('testGeocode');
            if (testGeocodeBtn) {
                testGeocodeBtn.addEventListener('click', testNetworkConnectivity);
            }
            
            setupAutocomplete('currentLocation');
            setupAutocomplete('birthPlace');
            
            // Test network connectivity on load
            testNetworkConnectivity();
            
            if (!firebaseInitialized) {
                var existingMembers = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                if (existingMembers.length === 0) {
                    var demoMembers = [
                        {
                            id: '1',
                            name: 'Sarah Chen',
                            role: 'Senior Developer',
                            currentLocation: 'Toronto, Canada',
                            birthPlace: 'Shanghai, China',
                            notes: 'Full-stack developer specializing in React and Node.js'
                        },
                        {
                            id: '2',
                            name: 'Marcus Johnson',
                            role: 'Product Manager',
                            currentLocation: 'New York, USA',
                            birthPlace: 'Lagos, Nigeria',
                            notes: 'Passionate about user experience and agile methodologies'
                        }
                    ];
                    
                    localStorage.setItem('teamMembers', JSON.stringify(demoMembers));
                    showMessage('Demo data added', 'info');
                    loadTeamMembers();
                }
            }
            
            showMessage('Application initialization complete', 'success');
        };

        // Add debug access via console
        window.enableDebug = function() {
            console.log('Debug mode enabled - check browser console for detailed logs');
        };
        
        console.log('Team Location Map loaded. Type "enableDebug()" to see debug information.');
    </script>
</body>
</html>
