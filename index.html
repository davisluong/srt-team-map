
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Location Map - Admin Controlled Platform</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .config-notice {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            text-align: center;
            z-index: 3000;
            font-weight: bold;
        }

        .config-notice.hidden {
            display: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 60px; /* Account for config notice */
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #cbd5e0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .role-badge {
            background: #48bb78;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .role-badge.viewer {
            background: #4299e1;
        }

        .container {
            display: flex;
            height: calc(100vh - 140px); /* Account for header and config notice */
            gap: 1rem;
            padding: 1rem;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 1.5rem;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .map-container {
            flex: 1;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .auth-form {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .auth-title {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #2d3748;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4299e1;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .team-member {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .team-member:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .member-name {
            font-weight: bold;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .member-role {
            color: #4299e1;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .member-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .btn-edit {
            background: #ed8936;
        }

        .btn-edit:hover {
            background: #dd6b20;
        }

        .btn-delete {
            background: #e53e3e;
        }

        .btn-delete:hover {
            background: #c53030;
        }

        .member-info {
            font-size: 0.9rem;
            color: #4a5568;
            line-height: 1.4;
        }

        .toggle-container {
            background: rgba(255, 255, 255, 0.9);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 24px;
            background: #cbd5e0;
            border-radius: 12px;
            transition: background 0.3s ease;
        }

        .switch.active {
            background: #4299e1;
        }

        .switch::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
        }

        .switch.active::before {
            transform: translateX(26px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2d3748;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
        }

        .close-btn:hover {
            color: #2d3748;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
        }

        .status-dot.offline {
            background: #e53e3e;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #718096;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .permission-notice {
            background: #bee3f8;
            color: #2c5282;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }

        .admin-only {
            display: none;
        }

        .admin-only.show {
            display: flex;
        }

        .admin-only.show-block {
            display: block;
        }

        .config-instructions {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .config-instructions h3 {
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .config-instructions code {
            background: #e2e8f0;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .config-instructions pre {
            background: #1a202c;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 300px;
            }
            
            .map-container {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Configuration Notice -->
    <div id="configNotice" class="config-notice">
        ‚ö†Ô∏è Firebase configuration needed! Please update your Firebase config in the code.
        <button onclick="hideConfigNotice()" style="margin-left: 1rem; background: #c53030; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer;">Hide</button>
    </div>

    <!-- Configuration Instructions (shown when config is not set) -->
    <div id="configInstructions" class="config-instructions">
        <h3>üîß Firebase Configuration Required</h3>
        <p>To use this application, you need to configure Firebase. Follow these steps:</p>
        
        <h4>Step 1: Get Firebase Configuration</h4>
        <ol>
            <li>Go to <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
            <li>Select your project (or create a new one)</li>
            <li>Click the gear icon ‚öôÔ∏è ‚Üí "Project settings"</li>
            <li>Scroll to "Your apps" ‚Üí Click web icon &lt;/&gt;</li>
            <li>Register app with nickname "team-location-map"</li>
            <li>Copy the configuration object</li>
        </ol>

        <h4>Step 2: Update Configuration in Code</h4>
        <p>Find this section in the code and replace with your actual values:</p>
        <pre><code>
            // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCgEh2UhEZFCFtn_2h_scIA8YHYTPHPy2M",
  authDomain: "srt-team-map.firebaseapp.com",
  databaseURL: "https://srt-team-map-default-rtdb.firebaseio.com",
  projectId: "srt-team-map",
  storageBucket: "srt-team-map.firebasestorage.app",
  messagingSenderId: "1041786833700",
  appId: "1:1041786833700:web:66bed6ec42cc8eb75d81b1",
  measurementId: "G-4TRCZJ2Q2L"
};
</code></pre>

        <h4>Step 3: Set Admin Email</h4>
        <p>Also update the admin email:</p>
        <pre><code>const ADMIN_EMAIL = 'davisluong84@gmail.com';</code></pre>

        <h4>Step 4: Enable Firebase Services</h4>
        <ul>
            <li>Enable Authentication (Email/Password and Google)</li>
            <li>Create Firestore Database</li>
            <li>Update Firestore rules (see documentation)</li>
        </ul>
    </div>

    <!-- Authentication Container -->
    <div id="authContainer" class="auth-container" style="display: none;">
        <div class="auth-form">
            <div class="auth-title">Team Location Map</div>
            <div id="authError" class="error-message" style="display: none;"></div>
            
            <form id="authForm">
                <div class="form-group">
                    <label for="authEmail">Email</label>
                    <input type="email" id="authEmail" required>
                </div>
                
                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" required>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn" style="flex: 1;" data-action="login">
                        <i class="fas fa-sign-in-alt"></i>
                        Sign In
                    </button>
                    <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="toggleAuthMode()">
                        Sign Up
                    </button>
                </div>
                
                <div style="text-align: center; margin-top: 1rem;">
                    <button type="button" class="btn" onclick="signInWithGoogle()" style="width: 100%;">
                        <i class="fab fa-google"></i>
                        Continue with Google
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <div class="header">
            <div class="logo">
                <i class="fas fa-globe-americas"></i>
                Team Location Map
            </div>
            <div class="user-info">
                <div class="status-indicator">
                    <div class="status-dot" id="connectionStatus"></div>
                    <span id="connectionText">Connected</span>
                </div>
                <span id="userEmail"></span>
                <div class="role-badge" id="userRole">Viewer</div>
                <div class="controls">
                    <button class="btn admin-only" id="addMemberBtn" onclick="openAddModal()">
                        <i class="fas fa-plus"></i>
                        Add Team Member
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        Export Data
                    </button>
                    <button class="btn btn-danger" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sign Out
                    </button>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="sidebar">
                <div class="toggle-container">
                    <div class="toggle-switch" onclick="toggleConnections()">
                        <div class="switch" id="connectionToggle"></div>
                        <span>Show Connection Lines</span>
                    </div>
                </div>

                <div id="permissionNotice" class="permission-notice" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    You have view-only access. Only the admin can modify team member data.
                </div>

                <div class="section-title">
                    <i class="fas fa-users"></i>
                    Team Members
                    <span id="memberCount" style="font-size: 0.8rem; color: #718096;">(0)</span>
                </div>
                
                <div id="teamList">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        Loading team members...
                    </div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Add Team Member</div>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <div id="modalError" class="error-message" style="display: none;"></div>
            
            <form id="memberForm">
                <div class="form-group">
                    <label for="memberName">Name *</label>
                    <input type="text" id="memberName" required>
                </div>
                
                <div class="form-group">
                    <label for="memberRole">Role *</label>
                    <input type="text" id="memberRole" required>
                </div>
                
                <div class="form-group">
                    <label for="currentLocation">Current Location *</label>
                    <input type="text" id="currentLocation" placeholder="e.g., New York, USA" required>
                </div>
                
                <div class="form-group">
                    <label for="birthPlace">Birth Place *</label>
                    <input type="text" id="birthPlace" placeholder="e.g., London, UK" required>
                </div>
                
                <div class="form-group">
                    <label for="memberNotes">Notes</label>
                    <textarea id="memberNotes" placeholder="Additional information about the team member..."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i>
                        Save Member
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            signInWithPopup,
            GoogleAuthProvider,
            signOut as firebaseSignOut,
            onAuthStateChanged 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            doc, 
            updateDoc, 
            deleteDoc, 
            onSnapshot,
            serverTimestamp,
            getDoc 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // TODO: Replace with your Firebase config
        const firebaseConfig = {
            // PASTE YOUR FIREBASE CONFIG HERE
            apiKey: "your-api-key-here",
            authDomain: "your-project.firebaseapp.com",
            projectId: "your-project-id",
            storageBucket: "your-project.appspot.com",
            messagingSenderId: "123456789",
            appId: "your-app-id"
        };

        // Check if Firebase config is properly set
        const isConfigured = firebaseConfig.apiKey !== "your-api-key-here" && 
                           firebaseConfig.apiKey.startsWith("AIzaSy");

        if (!isConfigured) {
            // Show configuration instructions
            document.getElementById('configInstructions').style.display = 'block';
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('mainApp').style.display = 'none';
            return; // Don't initialize Firebase
        } else {
            // Hide configuration instructions
            document.getElementById('configInstructions').style.display = 'none';
            document.getElementById('configNotice').classList.add('hidden');
        }

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Make Firebase available globally
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseProvider = provider;
        window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
        window.firebaseCreateUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseSignOut = firebaseSignOut;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseGetDocs = getDocs;
        window.firebaseDoc = doc;
        window.firebaseUpdateDoc = updateDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseOnSnapshot = onSnapshot;
        window.firebaseServerTimestamp = serverTimestamp;
        window.firebaseGetDoc = getDoc;

        // Initialize the app once Firebase is loaded
        initializeApp();
    </script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        let map;
        let teamMembers = [];
        let currentEditId = null;
        let showConnections = false;
        let markers = [];
        let connectionLines = [];
        let currentUser = null;
        let unsubscribeTeamMembers = null;
        let isAuthMode = 'login';
        let isAdmin = false;

        // Admin email - CHANGE THIS TO YOUR EMAIL
        const ADMIN_EMAIL = 'your-admin-email@example.com';

        // Hide config notice
        function hideConfigNotice() {
            document.getElementById('configNotice').classList.add('hidden');
        }

        // Initialize the application
        function initializeApp() {
            // Check if Firebase is configured
            if (!window.firebaseAuth) {
                return; // Firebase not configured
            }

            // Check authentication state
            window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    currentUser = user;
                    isAdmin = user.email === ADMIN_EMAIL;
                    
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    document.getElementById('userEmail').textContent = user.email;
                    
                    updateUIForRole();
                    initializeMap();
                    subscribeToTeamMembers();
                } else {
                    currentUser = null;
                    isAdmin = false;
                    document.getElementById('authContainer').style.display = 'flex';
                    document.getElementById('mainApp').style.display = 'none';
                    
                    if (unsubscribeTeamMembers) {
                        unsubscribeTeamMembers();
                    }
                }
            });

            // Setup auth form
            document.getElementById('authForm').addEventListener('submit', handleAuth);
        }

        // Update UI based on user role
        function updateUIForRole() {
            const roleElement = document.getElementById('userRole');
            const permissionNotice = document.getElementById('permissionNotice');
            const adminElements = document.querySelectorAll('.admin-only');
            
            if (isAdmin) {
                roleElement.textContent = 'Admin';
                roleElement.className = 'role-badge';
                permissionNotice.style.display = 'none';
                
                // Show admin controls
                adminElements.forEach(el => {
                    if (el.classList.contains('admin-only')) {
                        el.classList.add('show');
                    }
                });
            } else {
                roleElement.textContent = 'Viewer';
                roleElement.className = 'role-badge viewer';
                permissionNotice.style.display = 'block';
                
                // Hide admin controls
                adminElements.forEach(el => {
                    el.classList.remove('show', 'show-block');
                });
            }
        }

        // Handle authentication
        async function handleAuth(e) {
            e.preventDefault();
            
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const action = e.submitter.dataset.action || isAuthMode;

            try {
                if (action === 'login') {
                    await window.firebaseSignInWithEmailAndPassword(window.firebaseAuth, email, password);
                } else {
                    await window.firebaseCreateUserWithEmailAndPassword(window.firebaseAuth, email, password);
                }
                hideAuthError();
            } catch (error) {
                showAuthError(error.message);
            }
        }

        // Sign in with Google
        async function signInWithGoogle() {
            try {
                await window.firebaseSignInWithPopup(window.firebaseAuth, window.firebaseProvider);
                hideAuthError();
            } catch (error) {
                showAuthError(error.message);
            }
        }

        // Sign out
        async function signOut() {
            try {
                await window.firebaseSignOut(window.firebaseAuth);
            } catch (error) {
                console.error('Sign out error:', error);
            }
        }

        // Toggle auth mode
        function toggleAuthMode() {
            isAuthMode = isAuthMode === 'login' ? 'signup' : 'login';
            const submitBtn = document.querySelector('[data-action="login"]');
            const toggleBtn = document.querySelector('.btn-secondary');
            
            if (isAuthMode === 'signup') {
                submitBtn.innerHTML = '<i class="fas fa-user-plus"></i> Sign Up';
                submitBtn.dataset.action = 'signup';
                toggleBtn.textContent = 'Sign In';
            } else {
                submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                submitBtn.dataset.action = 'login';
                toggleBtn.textContent = 'Sign Up';
            }
        }

        // Show/hide auth errors
        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideAuthError() {
            document.getElementById('authError').style.display = 'none';
        }

        // Initialize the map
        function initializeMap() {
            if (map) return; // Already initialized
            
            map = L.map('map').setView([20, 0], 2);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Subscribe to team members from Firestore
        function subscribeToTeamMembers() {
            const teamCollection = window.firebaseCollection(window.firebaseDb, 'teamMembers');
            
            unsubscribeTeamMembers = window.firebaseOnSnapshot(teamCollection, (snapshot) => {
                teamMembers = [];
                snapshot.forEach((doc) => {
                    teamMembers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                renderTeamList();
                updateMap();
                updateConnectionStatus(true);
            }, (error) => {
                console.error('Error listening to team members:', error);
                updateConnectionStatus(false);
            });
        }

        // Update connection status
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            if (connected) {
                statusDot.classList.remove('offline');
                statusText.textContent = 'Connected';
            } else {
                statusDot.classList.add('offline');
                statusText.textContent = 'Offline';
            }
        }

        // Geocoding function (simplified - in production use a proper geocoding service)
        async function geocodeLocation(location) {
            const geocodeData = {
                "Toronto, Canada": [43.6532, -79.3832],
                "Vancouver, Canada": [49.2827, -123.1207],
                "Mexico City, Mexico": [19.4326, -99.1332],
                "Guadalajara, Mexico": [20.6597, -103.3496],
                "London, UK": [51.5074, -0.1278],
                "Mumbai, India": [19.0760, 72.8777],
                "New York, USA": [40.7128, -74.0060],
                "Los Angeles, USA": [34.0522, -118.2437],
                "Paris, France": [48.8566, 2.3522],
                "Berlin, Germany": [52.5200, 13.4050],
                "Tokyo, Japan": [35.6762, 139.6503],
                "Sydney, Australia": [-33.8688, 151.2093],
                "S√£o Paulo, Brazil": [-23.5505, -46.6333],
                "Cape Town, South Africa": [-33.9249, 18.4241]
            };
            
            return geocodeData[location] || [0, 0];
        }

        // Render team list
        function renderTeamList() {
            const teamList = document.getElementById('teamList');
            const memberCount = document.getElementById('memberCount');
            
            memberCount.textContent = `(${teamMembers.length})`;
            teamList.innerHTML = '';

            if (teamMembers.length === 0) {
                teamList.innerHTML = '<p style="text-align: center; color: #718096; font-style: italic;">No team members added yet.</p>';
                return;
            }

            teamMembers.forEach(member => {
                const memberDiv = document.createElement('div');
                memberDiv.className = 'team-member';
                
                const actionsHtml = isAdmin ? `
                    <div class="member-actions">
                        <button class="btn btn-small btn-edit" onclick="editMember('${member.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-small btn-delete" onclick="deleteMember('${member.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : '';
                
                memberDiv.innerHTML = `
                    <div class="member-header">
                        <div>
                            <div class="member-name">${member.name}</div>
                            <div class="member-role">${member.role}</div>
                        </div>
                        ${actionsHtml}
                    </div>
                    <div class="member-info">
                        <div><strong>Current:</strong> ${member.currentLocation}</div>
                        <div><strong>Born:</strong> ${member.birthPlace}</div>
                        ${member.notes ? `<div><strong>Notes:</strong> ${member.notes}</div>` : ''}
                    </div>
                `;
                teamList.appendChild(memberDiv);
            });
        }

        // Update map with markers and connections
        function updateMap() {
            if (!map) return;
            
            // Clear existing markers and lines
            markers.forEach(marker => map.removeLayer(marker));
            connectionLines.forEach(line => map.removeLayer(line));
            markers = [];
            connectionLines = [];

            // Add markers for each team member
            teamMembers.forEach(member => {
                if (member.currentCoords && member.birthCoords) {
                    // Current location marker (blue)
                    const currentMarker = L.marker(member.currentCoords)
                        .addTo(map)
                        .bindPopup(`
                            <div style="text-align: center;">
                                <strong>${member.name}</strong><br>
                                <em>${member.role}</em><br>
                                <small>Current Location</small>
                            </div>
                        `);
                    markers.push(currentMarker);

                    // Birth place marker (green)
                    const birthMarker = L.marker(member.birthCoords, {
                        icon: L.icon({
                            iconUrl: 'data:image/svg+xml;base64,' + btoa(`
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="green" width="25" height="41">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                </svg>
                            `),
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34]
                        })
                    })
                        .addTo(map)
                        .bindPopup(`
                            <div style="text-align: center;">
                                <strong>${member.name}</strong><br>
                                <em>${member.role}</em><br>
                                <small>Birth Place</small>
                            </div>
                        `);
                    markers.push(birthMarker);

                    // Connection line (if enabled)
                    if (showConnections) {
                        const connectionLine = L.polyline([member.currentCoords, member.birthCoords], {
                            color: '#4299e1',
                            weight: 2,
                            opacity: 0.7,
                            dashArray: '10, 10'
                        }).addTo(map);
                        connectionLines.push(connectionLine);
                    }
                }
            });
        }

        // Toggle connection lines
        function toggleConnections() {
            showConnections = !showConnections;
            const toggle = document.getElementById('connectionToggle');
            
            if (showConnections) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
            
            updateMap();
        }

        // Open add modal (admin only)
        function openAddModal() {
            if (!isAdmin) {
                alert('Only the admin can add team members.');
                return;
            }
            
            currentEditId = null;
            document.getElementById('modalTitle').textContent = 'Add Team Member';
            document.getElementById('memberForm').reset();
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('memberModal').style.display = 'block';
        }

        // Edit member (admin only)
        function editMember(id) {
            if (!isAdmin) {
                alert('Only the admin can edit team members.');
                return;
            }
            
            const member = teamMembers.find(m => m.id === id);
            if (!member) return;

            currentEditId = id;
            document.getElementById('modalTitle').textContent = 'Edit Team Member';
            document.getElementById('memberName').value = member.name;
            document.getElementById('memberRole').value = member.role;
            document.getElementById('currentLocation').value = member.currentLocation;
            document.getElementById('birthPlace').value = member.birthPlace;
            document.getElementById('memberNotes').value = member.notes || '';
            document.getElementById('modalError').style.display = 'none';
            document.getElementById('memberModal').style.display = 'block';
        }

        // Delete member (admin only)
        async function deleteMember(id) {
            if (!isAdmin) {
                alert('Only the admin can delete team members.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this team member?')) {
                try {
                    await window.firebaseDeleteDoc(window.firebaseDoc(window.firebaseDb, 'teamMembers', id));
                } catch (error) {
                    console.error('Error deleting member:', error);
                    alert('Error deleting team member. Please try again.');
                }
            }
        }

        // Close modal
        function closeModal() {
            document.getElementById('memberModal').style.display = 'none';
            currentEditId = null;
        }

        // Show modal error
        function showModalError(message) {
            const errorDiv = document.getElementById('modalError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Handle form submission (admin only)
        document.getElementById('memberForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!isAdmin) {
                showModalError('Only the admin can modify team member data.');
                return;
            }

            const name = document.getElementById('memberName').value;
            const role = document.getElementById('memberRole').value;
            const currentLocation = document.getElementById('currentLocation').value;
            const birthPlace = document.getElementById('birthPlace').value;
            const notes = document.getElementById('memberNotes').value;

            try {
                // Geocode locations
                const currentCoords = await geocodeLocation(currentLocation);
                const birthCoords = await geocodeLocation(birthPlace);

                const memberData = {
                    name,
                    role,
                    currentLocation,
                    birthPlace,
                    notes,
                    currentCoords,
                    birthCoords,
                    createdAt: window.firebaseServerTimestamp(),
                    createdBy: currentUser.uid
                };

                if (currentEditId) {
                    // Edit existing member
                    await window.firebaseUpdateDoc(
                        window.firebaseDoc(window.firebaseDb, 'teamMembers', currentEditId), 
                        {
                            ...memberData,
                            updatedAt: window.firebaseServerTimestamp()
                        }
                    );
                } else {
                    // Add new member
                    await window.firebaseAddDoc(
                        window.firebaseCollection(window.firebaseDb, 'teamMembers'), 
                        memberData
                    );
                }

                closeModal();
            } catch (error) {
                console.error('Error saving member:', error);
                showModalError('Error saving team member. Please try again.');
            }
        });

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(teamMembers, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `team-members-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(e) {
            const modal = document.getElementById('memberModal');
            if (e.target === modal) {
                closeModal();
            }
        });
    </script>
</body>
</html>
