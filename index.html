
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Location Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.1rem; opacity: 0.9; }
        .admin-toggle { position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s ease; backdrop-filter: blur(10px); }
        .admin-toggle:hover { background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); }
        .main-content { display: grid; grid-template-columns: 1fr 400px; gap: 20px; height: calc(100vh - 150px); }
        .main-content.view-only { grid-template-columns: 1fr 350px; }
        .map-container { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .toggle-btn { background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s ease; }
        .toggle-btn:hover { background: #45a049; transform: translateY(-2px); }
        .toggle-btn.inactive { background: #f44336; }
        #map { height: calc(100% - 60px); border-radius: 10px; border: 2px solid #e0e0e0; }
        .sidebar { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow-y: auto; }
        .sidebar.hidden { display: none; }
        .sidebar h2 { color: #333; margin-bottom: 20px; text-align: center; font-size: 1.5rem; }
        .view-only-sidebar { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow-y: auto; }
        .view-only-sidebar h2 { color: #333; margin-bottom: 20px; text-align: center; font-size: 1.3rem; }
        .form-group { margin-bottom: 15px; position: relative; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border-color 0.3s ease; }
        .form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .profile-photo-section { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .profile-photo-preview { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #e0e0e0; object-fit: cover; background: #f8f9fa; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #666; overflow: hidden; }
        .profile-photo-input { flex: 1; }
        .profile-photo-input input { margin-bottom: 5px; }
        .photo-help-text { font-size: 11px; color: #666; font-style: italic; }
        .autocomplete-container { position: relative; }
        .autocomplete-suggestions { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
        .autocomplete-suggestions.active { display: block; }
        .suggestion-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: background-color 0.2s ease; }
        .suggestion-item:hover, .suggestion-item.highlighted { background-color: #f8f9fa; }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-main { font-weight: 600; color: #333; margin-bottom: 2px; }
        .suggestion-details { font-size: 12px; color: #666; }
        .loading-indicator { padding: 12px; text-align: center; color: #666; font-style: italic; }
        .btn { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s ease; width: 100%; margin-bottom: 10px; }
        .btn:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .team-list { margin-top: 20px; }
        .team-member { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px; transition: all 0.3s ease; }
        .team-member:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .member-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .member-photo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e0e0e0; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 16px; color: #666; flex-shrink: 0; overflow: hidden; }
        .member-info { flex: 1; }
        .member-name { font-weight: bold; color: #333; font-size: 16px; margin-bottom: 2px; }
        .member-role { color: #667eea; font-weight: 600; font-size: 14px; }
        .member-locations { font-size: 12px; color: #666; margin-bottom: 8px; }
        .member-actions { display: flex; gap: 8px; }
        .btn-small { padding: 5px 12px; font-size: 12px; width: auto; margin: 0; }
        .firebase-status { background: #ffebee; color: #c62828; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 12px; }
        .view-only-info { background: #e3f2fd; color: #1565c0; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-size: 14px; border: 1px solid #bbdefb; }
        .view-only-info h3 { margin-bottom: 8px; color: #0d47a1; }
        .success-message { background: #d4edda; color: #155724; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 12px; border: 1px solid #c3e6cb; display: none; }
        .error-message { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 12px; border: 1px solid #f5c6cb; display: none; }
        .profile-marker { width: 40px; height: 40px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); object-fit: cover; }
        .emoji-marker { background: #007bff; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .input-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #666; pointer-events: none; }
        .form-group.has-icon input { padding-right: 35px; }
        .mode-indicator { position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; z-index: 1000; }
        .mode-indicator.admin { background: rgba(220, 53, 69, 0.8); }
        .mode-indicator.view { background: rgba(40, 167, 69, 0.8); }
        .team-member.view-only { cursor: default; }
        .team-member.view-only:hover { transform: none; }
        @media (max-width: 1024px) {
            .main-content { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
            .sidebar, .view-only-sidebar { max-height: 400px; }
            .admin-toggle { position: relative; top: 0; right: 0; margin-bottom: 20px; display: block; width: fit-content; margin-left: auto; margin-right: auto; }
            .profile-photo-section { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <div class="container">
        <button class="admin-toggle" onclick="toggleAdminMode()" id="adminToggle">üîß Admin Mode</button>
        <div class="header">
            <h1>üåç Team Location Map</h1>
            <p>Visualize your global team connections</p>
        </div>
        <div class="main-content" id="mainContent">
            <div class="map-container">
                <div class="controls">
                    <h3>World Map</h3>
                    <button id="toggleLines" class="toggle-btn">üîó Hide Birth Places & Lines</button>
                </div>
                <div id="map"></div>
            </div>
            <div class="sidebar" id="sidebar">
                <div id="firebaseStatus" class="firebase-status">‚ö†Ô∏è Using local storage (Firebase not configured)</div>
                <div class="success-message" id="successMessage"></div>
                <div class="error-message" id="errorMessage"></div>
                <h2>üë• Team Management</h2>
                <form id="teamForm">
                    <div class="form-group">
                        <label for="name">Name *</label>
                        <input type="text" id="name" required>
                    </div>
                    <div class="form-group">
                        <label for="role">Role *</label>
                        <input type="text" id="role" required>
                    </div>
                    <div class="form-group">
                        <label>Profile Photo</label>
                        <div class="profile-photo-section">
                            <div class="profile-photo-preview" id="photoPreview">üë§</div>
                            <div class="profile-photo-input">
                                <input type="url" id="profilePhoto" placeholder="Enter photo URL (optional)">
                                <div class="photo-help-text">Paste a URL to an image (JPG, PNG, GIF)</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group has-icon">
                        <label for="currentLocation">Current Location *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="currentLocation" placeholder="Start typing city name..." required autocomplete="off">
                            <span class="input-icon">üîç</span>
                            <div class="autocomplete-suggestions" id="currentLocationSuggestions"></div>
                        </div>
                    </div>
                    <div class="form-group has-icon">
                        <label for="birthPlace">Birth Place *</label>
                        <div class="autocomplete-container">
                            <input type="text" id="birthPlace" placeholder="Start typing city name..." required autocomplete="off">
                            <span class="input-icon">üîç</span>
                            <div class="autocomplete-suggestions" id="birthPlaceSuggestions"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" placeholder="Additional information..."></textarea>
                    </div>
                    <button type="submit" class="btn" id="submitBtn">‚ûï Add Team Member</button>
                    <button type="button" id="cancelEdit" class="btn btn-secondary" style="display: none;">‚ùå Cancel Edit</button>
                </form>
                <div class="team-list">
                    <h3>Team Members (<span id="memberCount">0</span>)</h3>
                    <div id="teamMembers"></div>
                </div>
            </div>
            <div class="view-only-sidebar" id="viewOnlySidebar" style="display: none;">
                <div class="view-only-info">
                    <h3>üëÅÔ∏è Team Directory</h3>
                
                    <p>Explore our global team members and their locations on the map.</p>
                </div>
                <h2>üë• Our Team (<span id="viewOnlyMemberCount">0</span>)</h2>
                <div id="viewOnlyTeamMembers"></div>
            </div>
        </div>
        <div class="mode-indicator view" id="modeIndicator">üëÅÔ∏è View Mode</div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var teamMembers = [], markers = [], connectionLines = [];
        var showLines = true, editingId = null, isAdminMode = false, searchTimeouts = {};
        var selectedSuggestionIndex = -1, currentSuggestions = [], map = null;

        function showMessage(message, type) {
            console.log('[' + type.toUpperCase() + '] ' + message);
            if (type === 'success') {
                var successEl = document.getElementById('successMessage');
                if (successEl) {
                    successEl.textContent = message;
                    successEl.style.display = 'block';
                    setTimeout(() => successEl.style.display = 'none', 3000);
                }
            } else if (type === 'error') {
                var errorEl = document.getElementById('errorMessage');
                if (errorEl) {
                    errorEl.textContent = message;
                    errorEl.style.display = 'block';
                    setTimeout(() => errorEl.style.display = 'none', 5000);
                }
            }
        }

        function setupProfilePhotoPreview() {
            var photoInput = document.getElementById('profilePhoto');
            var photoPreview = document.getElementById('photoPreview');
            if (photoInput && photoPreview) {
                photoInput.addEventListener('input', function() {
                    var url = this.value.trim();
                    if (url) {
                        var testImg = new Image();
                        testImg.onload = () => {
                            photoPreview.innerHTML = `<img src="${url}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                        };
                        testImg.onerror = () => {
                            photoPreview.innerHTML = '‚ùå';
                            setTimeout(() => photoPreview.innerHTML = 'üë§', 2000);
                        };
                        testImg.src = url;
                    } else {
                        photoPreview.innerHTML = 'üë§';
                    }
                });
            }
        }

        function createProfilePhotoElement(photoUrl, size = 40, fallbackText = 'üë§') {
            if (photoUrl && photoUrl.trim()) {
                return `<img src="${photoUrl}" alt="Profile" class="member-photo" style="width: ${size}px; height: ${size}px;">`;
            } else {
                return `<div class="member-photo" style="width: ${size}px; height: ${size}px;">${fallbackText}</div>`;
            }
        }

        function initializeMap() {
            map = L.map('map', {
                center: [20, 0], zoom: 2, minZoom: 2, maxZoom: 18,
                worldCopyJump: true, maxBounds: [[-90, -180], [90, 180]], maxBoundsViscosity: 1.0
            });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors', noWrap: true
            }).addTo(map);
            showMessage('Map initialized', 'info');
        }

        function checkAdminMode() {
            var urlParams = new URLSearchParams(window.location.search);
            isAdminMode = urlParams.get('admin') === 'true';
            updateUIMode();
        }

        function toggleAdminMode() {
            isAdminMode = !isAdminMode;
            var url = new URL(window.location);
            if (isAdminMode) {
                url.searchParams.set('admin', 'true');
            } else {
                url.searchParams.delete('admin');
            }
            window.history.replaceState({}, '', url);
            updateUIMode();
        }

        function updateUIMode() {
            var mainContent = document.getElementById('mainContent');
            var sidebar = document.getElementById('sidebar');
            var viewOnlySidebar = document.getElementById('viewOnlySidebar');
            var adminToggle = document.getElementById('adminToggle');
            var modeIndicator = document.getElementById('modeIndicator');

            if (isAdminMode) {
                mainContent.classList.remove('view-only');
                sidebar.style.display = 'block';
                viewOnlySidebar.style.display = 'none';
                adminToggle.innerHTML = 'üëÅÔ∏è View Mode';
                modeIndicator.innerHTML = 'üîß Admin Mode';
                modeIndicator.className = 'mode-indicator admin';
            } else {
                mainContent.classList.add('view-only');
                sidebar.style.display = 'none';
                viewOnlySidebar.style.display = 'block';
                adminToggle.innerHTML = 'üîß Admin Mode';
                modeIndicator.innerHTML = 'üëÅÔ∏è View Mode';
                modeIndicator.className = 'mode-indicator view';
                displayViewOnlyTeamMembers();
            }
            if (map) {
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        function searchLocations(query, suggestionsContainer, inputElement) {
            suggestionsContainer.innerHTML = '<div class="loading-indicator">üîç Searching locations...</div>';
            suggestionsContainer.classList.add('active');
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=8&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        currentSuggestions = data;
                        displaySuggestions(data, suggestionsContainer, inputElement);
                    } else {
                        suggestionsContainer.innerHTML = '<div class="loading-indicator">No locations found</div>';
                    }
                })
                .catch(error => {
                    console.error('Location search error:', error);
                    suggestionsContainer.innerHTML = '<div class="loading-indicator">Search temporarily unavailable</div>';
                });
        }

        function displaySuggestions(suggestions, container, inputElement) {
            selectedSuggestionIndex = -1;
            var html = suggestions.map((suggestion, index) => {
                var displayName = suggestion.display_name;
                var parts = displayName.split(',');
                var mainLocation = parts.slice(0, 2).join(',').trim();
                var details = parts.slice(2).join(',').trim();
                return `<div class="suggestion-item" data-index="${index}" onclick="selectSuggestion(${index}, '${inputElement.id}')">
                    <div class="suggestion-main">${mainLocation}</div>
                    ${details ? `<div class="suggestion-details">${details}</div>` : ''}
                </div>`;
            }).join('');
            container.innerHTML = html;
            container.classList.add('active');
        }

        function selectSuggestion(index, inputId) {
            if (currentSuggestions[index]) {
                var suggestion = currentSuggestions[index];
                var input = document.getElementById(inputId);
                var container = document.getElementById(inputId + 'Suggestions');
                var displayName = suggestion.display_name;
                var parts = displayName.split(',');
                var cleanName = parts.slice(0, 2).join(',').trim();
                input.value = cleanName;
                container.classList.remove('active');
                input.focus();
            }
        }

        function setupAutocomplete(inputId) {
            var input = document.getElementById(inputId);
            var suggestionsContainer = document.getElementById(inputId + 'Suggestions');
            if (!input || !suggestionsContainer) return;

            input.addEventListener('input', function() {
                var query = this.value.trim();
                if (query.length < 2) {
                    suggestionsContainer.classList.remove('active');
                    return;
                }
                if (searchTimeouts[inputId]) {
                    clearTimeout(searchTimeouts[inputId]);
                }
                searchTimeouts[inputId] = setTimeout(() => {
                    searchLocations(query, suggestionsContainer, input);
                }, 500);
            });

            input.addEventListener('blur', () => {
                setTimeout(() => suggestionsContainer.classList.remove('active'), 200);
            });

            input.addEventListener('focus', function() {
                if (this.value.trim().length >= 2) {
                    searchLocations(this.value.trim(), suggestionsContainer, input);
                }
            });
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            var submitBtn = document.getElementById('submitBtn');
            var originalText = submitBtn.textContent;
            
            try {
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Saving...';
                
                var formData = {
                    name: document.getElementById('name').value.trim(),
                    role: document.getElementById('role').value.trim(),
                    profilePhoto: document.getElementById('profilePhoto').value.trim(),
                    currentLocation: document.getElementById('currentLocation').value.trim(),
                    birthPlace: document.getElementById('birthPlace').value.trim(),
                    notes: document.getElementById('notes').value.trim(),
                    timestamp: new Date().toISOString()
                };

                if (!formData.name || !formData.role || !formData.currentLocation || !formData.birthPlace) {
                    throw new Error('Please fill in all required fields');
                }

                if (editingId) {
                    updateTeamMember(editingId, formData).then(() => {
                        showMessage('Team member updated successfully!', 'success');
                        resetForm();
                        loadTeamMembers();
                    });
                } else {
                    addTeamMember(formData).then(() => {
                        showMessage('Team member added successfully!', 'success');
                        resetForm();
                        loadTeamMembers();
                    });
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        function resetForm() {
            document.getElementById('teamForm').reset();
            document.getElementById('photoPreview').innerHTML = 'üë§';
            editingId = null;
            document.getElementById('cancelEdit').style.display = 'none';
            document.querySelector('.btn[type="submit"]').textContent = '‚ûï Add Team Member';
        }

        function addTeamMember(memberData) {
            return new Promise((resolve) => {
                var members = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                memberData.id = Date.now().toString();
                members.push(memberData);
                localStorage.setItem('teamMembers', JSON.stringify(members));
                resolve();
            });
        }

        function updateTeamMember(id, memberData) {
            return new Promise((resolve, reject) => {
                var members = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                var index = members.findIndex(m => m.id === id);
                if (index !== -1) {
                    members[index] = Object.assign(members[index], memberData);
                    localStorage.setItem('teamMembers', JSON.stringify(members));
                    resolve();
                } else {
                    reject(new Error('Team member not found'));
                }
            });
        }

        function deleteTeamMember(id) {
            if (confirm('Are you sure you want to delete this team member?')) {
                var members = JSON.parse(localStorage.getItem('teamMembers') || '[]');
                var filtered = members.filter(m => m.id !== id);
                localStorage.setItem('teamMembers', JSON.stringify(filtered));
                showMessage('Team member deleted successfully', 'success');
                loadTeamMembers();
            }
        }

        function loadTeamMembers() {
            teamMembers = JSON.parse(localStorage.getItem('teamMembers') || '[]');
            displayTeamMembers();
            displayViewOnlyTeamMembers();
            updateMap();
        }

        function displayTeamMembers() {
            var container = document.getElementById('teamMembers');
            var count = document.getElementById('memberCount');
            if (count) count.textContent = teamMembers.length;
            
            if (teamMembers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No team members added yet.</p>';
                return;
            }

            container.innerHTML = teamMembers.map(member => `
                <div class="team-member">
                    <div class="member-header">
                        ${createProfilePhotoElement(member.profilePhoto, 40, 'üë§')}
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-role">${member.role}</div>
                        </div>
                    </div>
                    <div class="member-locations">
                        üìç Current: ${member.currentLocation}<br>
                        üè† Born: ${member.birthPlace}
                    </div>
                    ${member.notes ? `<div style="font-size: 12px; color: #666; margin-bottom: 8px;">${member.notes}</div>` : ''}
                    <div class="member-actions">
                        <button class="btn btn-secondary btn-small" onclick="editTeamMember('${member.id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteTeamMember('${member.id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function displayViewOnlyTeamMembers() {
            var container = document.getElementById('viewOnlyTeamMembers');
            var count = document.getElementById('viewOnlyMemberCount');
            if (count) count.textContent = teamMembers.length;
            
            if (teamMembers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No team members to display.</p>';
                return;
            }

            container.innerHTML = teamMembers.map(member => `
                <div class="team-member view-only">
                    <div class="member-header">
                        ${createProfilePhotoElement(member.profilePhoto, 40, 'üë§')}
                        <div class="member-info">
                            <div class="member-name">${member.name}</div>
                            <div class="member-role">${member.role}</div>
                        </div>
                    </div>
                    <div class="member-locations">
                        üìç Current: ${member.currentLocation}<br>
                        üè† Born: ${member.birthPlace}
                    </div>
                    ${member.notes ? `<div style="font-size: 12px; color: #666; margin-bottom: 8px;">${member.notes}</div>` : ''}
                </div>
            `).join('');
        }

        function editTeamMember(id) {
            var member = teamMembers.find(m => m.id === id);
            if (!member) return;

            document.getElementById('name').value = member.name;
            document.getElementById('role').value = member.role;
            document.getElementById('profilePhoto').value = member.profile

Photo || '';
            document.getElementById('currentLocation').value = member.currentLocation;
            document.getElementById('birthPlace').value = member.birthPlace;
            document.getElementById('notes').value = member.notes || '';

            var photoPreview = document.getElementById('photoPreview');
            if (member.profilePhoto && member.profilePhoto.trim()) {
                photoPreview.innerHTML = `<img src="${member.profilePhoto}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
            } else {
                photoPreview.innerHTML = 'üë§';
            }

            editingId = id;
            document.getElementById('cancelEdit').style.display = 'block';
            document.querySelector('.btn[type="submit"]').textContent = 'üíæ Update Team Member';
        }

        function geocodeLocation(location) {
            return fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    }
                    return null;
                })
                .catch(error => {
                    console.error('Geocoding error:', error);
                    return null;
                });
        }

        function createMapMarker(member, coords, isCurrentLocation) {
            var markerHtml;
            if (!showLines && isCurrentLocation && member.profilePhoto && member.profilePhoto.trim()) {
                markerHtml = `<img src="${member.profilePhoto}" alt="${member.name}" class="profile-marker">`;
            } else {
                var emoji = isCurrentLocation ? 'üìç' : 'üè†';
                var bgColor = isCurrentLocation ? '#007bff' : '#28a745';
                var size = isCurrentLocation ? '30px' : '25px';
                markerHtml = `<div class="emoji-marker" style="background: ${bgColor}; width: ${size}; height: ${size};">${emoji}</div>`;
            }
            return L.marker(coords, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: markerHtml,
                    iconSize: isCurrentLocation ? [40, 40] : [25, 25],
                    iconAnchor: isCurrentLocation ? [20, 20] : [12.5, 12.5]
                })
            });
        }

        function updateMap() {
            if (!map) return;
            
            markers.forEach(marker => map.removeLayer(marker));
            connectionLines.forEach(line => map.removeLayer(line));
            markers = [];
            connectionLines = [];

            var promises = teamMembers.map(member => {
                return Promise.all([
                    geocodeLocation(member.currentLocation),
                    geocodeLocation(member.birthPlace)
                ]).then(coords => {
                    var currentCoords = coords[0];
                    var birthCoords = coords[1];

                    if (currentCoords) {
                        var currentMarker = createMapMarker(member, currentCoords, true).addTo(map);
                        currentMarker.bindPopup(`
                            <div style="font-family: 'Segoe UI', sans-serif;">
                                <h4 style="margin: 0 0 8px 0; color: #333;">${member.name}</h4>
                                <p style="margin: 0 0 4px 0; color: #007bff; font-weight: bold;">${member.role}</p>
                                <p style="margin: 0 0 4px 0; font-size: 12px;"><strong>Current:</strong> ${member.currentLocation}</p>
                                <p style="margin: 0 0 4px 0; font-size: 12px;"><strong>Born:</strong> ${member.birthPlace}</p>
                                ${member.notes ? `<p style="margin: 4px 0 0 0; font-size: 11px; color: #666; font-style: italic;">${member.notes}</p>` : ''}
                            </div>
                        `);
                        markers.push(currentMarker);
                    }

                    if (showLines && birthCoords) {
                        var birthMarker = createMapMarker(member, birthCoords, false).addTo(map);
                        birthMarker.bindPopup(`
                            <div style="font-family: 'Segoe UI', sans-serif;">
                                <h4 style="margin: 0 0 8px 0; color: #333;">${member.name}</h4>
                                <p style="margin: 0 0 4px 0; color: #28a745; font-weight: bold;">Birth Place</p>
                                <p style="margin: 0; font-size: 12px;">${member.birthPlace}</p>
                            </div>
                        `);
                        markers.push(birthMarker);
                    }

                    if (showLines && currentCoords && birthCoords) {
                        var line = L.polyline([currentCoords, birthCoords], {
                            color: '#ff6b6b', weight: 2, opacity: 0.7, dashArray: '10, 10'
                        }).addTo(map);
                        connectionLines.push(line);
                    }
                });
            });

            Promise.all(promises).then(() => {
                if (markers.length > 0) {
                    var group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                }
            });
        }

        function toggleConnectionLines() {
            showLines = !showLines;
            var button = document.getElementById('toggleLines');
            if (showLines) {
                button.textContent = 'üîó Hide Birth Places & Lines';
                button.className = 'toggle-btn';
            } else {
                button.textContent = 'üîó Show Birth Places & Lines';
                button.className = 'toggle-btn inactive';
            }
            updateMap();
        }

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            checkAdminMode();
            loadTeamMembers();
            
            document.getElementById('teamForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('toggleLines').addEventListener('click', toggleConnectionLines);
            document.getElementById('cancelEdit').addEventListener('click', resetForm);
            
            setupAutocomplete('currentLocation');
            setupAutocomplete('birthPlace');
            setupProfilePhotoPreview();
            
            // Add demo data if none exists
            var existingMembers = JSON.parse(localStorage.getItem('teamMembers') || '[]');
            if (existingMembers.length === 0) {
                var demoMembers = [
                    {
                        id: '1',
                        name: 'Sarah Chen',
                        role: 'Senior Developer',
                        currentLocation: 'Toronto, Canada',
                        birthPlace: 'Shanghai, China',
                        profilePhoto: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=150&h=150&fit=crop&crop=face',
                        notes: 'Full-stack developer specializing in React and Node.js'
                    },
                    {
                        id: '2',
                        name: 'Marcus Johnson',
                        role: 'Product Manager',
                        currentLocation: 'New York, USA',
                        birthPlace: 'Lagos, Nigeria',
                        profilePhoto: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face',
                        notes: 'Passionate about user experience and agile methodologies'
                    }
                ];
                localStorage.setItem('teamMembers', JSON.stringify(demoMembers));
                loadTeamMembers();
            }
        });
    </script>
</body>
</html>
